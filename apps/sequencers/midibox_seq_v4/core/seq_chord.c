// $Id$
/*
 * Chord Functions
 *
 * ==========================================================================
 *
 *  Copyright (C) 2008 Thorsten Klose (tk@midibox.org)
 *  Licensed for personal non-commercial use only.
 *  All other rights reserved.
 * 
 * ==========================================================================
 */

/////////////////////////////////////////////////////////////////////////////
// Include files
/////////////////////////////////////////////////////////////////////////////

#include <mios32.h>

#include "seq_chord.h"
#include "seq_core.h"


/////////////////////////////////////////////////////////////////////////////
// Local types
/////////////////////////////////////////////////////////////////////////////

typedef struct {
  s8   keys[6];
  char name[7];
} seq_chord_entry_t;


/////////////////////////////////////////////////////////////////////////////
// Local variables
/////////////////////////////////////////////////////////////////////////////

  // note: chords are used together with the forced-to-scale feature in seq_scale.c
  // if no key should be played, add -1
static const seq_chord_entry_t seq_chord_table[2][32] = {
  {
    // 1   2   3   4   5   6     <----> (6 chars!)
    {{ 0,  4,  7, -1, -1, -1 }, "Maj.I " },
    {{ 4,  7, 12, -1, -1, -1 }, "Maj.II" },
    {{ 7, 12, 16, -1, -1, -1 }, "MajIII" },
    {{ 0, -1, -1, -1, -1, -1 }, "Root  " },
    {{ 4, -1, -1, -1, -1, -1 }, "3rd   " },
    {{ 7, -1, -1, -1, -1, -1 }, "5th   " },
    {{ 0,  4, -1, -1, -1, -1 }, "R.+3rd" },
    {{ 0,  7, -1, -1, -1, -1 }, "R.+5th" },
    {{ 0,  4,  7,  9, -1, -1 }, "Maj.6 " },
    {{ 0,  4,  7, 11, -1, -1 }, "Maj.7 " },
    {{ 0,  4,  7, 12, -1, -1 }, "Maj.8 " },
    {{ 0,  4,  7, 14, -1, -1 }, "Maj.9 " },
    {{ 0,  7, 12, 16, -1, -1 }, "Maj.10" },
    {{ 0,  7, 12, 19, -1, -1 }, "Maj.12" },
    {{ 0,  5,  7, -1, -1, -1 }, "Sus.4 " },
    {{ 0,  4,  8, -1, -1, -1 }, "Maj.+ " },

    {{ 0,  3,  7, -1, -1, -1 }, "Min.I " },
    {{ 3,  7, 12, -1, -1, -1 }, "Min.II" },
    {{ 7, 12, 15, -1, -1, -1 }, "MinIII" },
    {{ 0, -1, -1, -1, -1, -1 }, "Root  " },
    {{ 3, -1, -1, -1, -1, -1 }, "3rdMin" },
    {{ 7, -1, -1, -1, -1, -1 }, "5th   " },
    {{ 0,  3, -1, -1, -1, -1 }, "R.+3rd" },
    {{ 0,  7, -1, -1, -1, -1 }, "R.+5th" },
    {{ 0,  3,  7,  9, -1, -1 }, "Min.6 " },
    {{ 0,  3,  7, 11, -1, -1 }, "Min.7 " },
    {{ 0,  3,  7, 12, -1, -1 }, "Min.8 " },
    {{ 0,  3,  7, 14, -1, -1 }, "Min.9 " },
    {{ 0,  7, 12, 16, -1, -1 }, "Min.10" },
    {{ 0,  7, 12, 18, -1, -1 }, "Min.12" },
    {{ 0,  3,  6,  9, -1, -1 }, "Co7   " },
    {{ 0,  3,  8, -1, -1, -1 }, "Min.+ " }
  }, {
    // see http://midibox.org/forums/topic/19886-extended-chords-dominants-tensions
    // corrected version at http://midibox.org/forums/topic/13137-midibox-seq-v4-release-feedback/?do=findComment&comment=174313
    {{ 0,  7, -1, -1, -1, -1 }, "Pwr5  " },
    {{ 0,  7, 12, -1, -1, -1 }, "Pwr8  " },
    {{ 0,  4, -1, -1, -1, -1 }, "R+mj3 " },
    {{ 0,  3, -1, -1, -1, -1 }, "R+min3" },
    // major chords
    {{ 0,  4,  7, -1, -1, -1 }, "Maj   " },
    {{ 0,  5,  7, -1, -1, -1 }, "Sus4  " },
    {{ 0,  4,  8, -1, -1, -1 }, "Maj+  " },
    {{ 0,  4,  7,  9, -1, -1 }, "Maj6  " },
    {{ 0,  4,  7, 11, -1, -1 }, "Maj7  " },
    {{ 0,  4,  7, 14, -1, -1 }, "add9  " },
    {{ 0,  4,  7, 11, 14, -1 }, "Maj9  " },
    {{ 0,  4,  7, 11, 14, 17 }, "Maj11 " },
    {{ 0,  4,  7, 11, 14, 21 }, "Maj13 " },
    // minor chords
    {{ 0,  3,  7, -1, -1, -1 }, "Min   " },
    {{ 0,  3,  7,  9, -1, -1 }, "Min6  " },
    {{ 0,  3,  7, 10, -1, -1 }, "Min7  " },
    {{ 0,  3,  7, 14, -1, -1 }, "Minad9" },
    {{ 0,  3,  7, 10, 14, -1 }, "Min9  " },
    {{ 0,  3,  7, 10, 14, 17 }, "Min11 " },
    {{ 0,  3,  7, 10, 14, 21 }, "Min13 " },
    // dominant chords
    {{ 0,  4,  7, 10, -1, -1 }, "Dom7  " },
    {{ 0,  5,  7, 10, -1, -1 }, "7Sus4 " },
    {{ 0,  4,  7, 10, 14, -1 }, "Dom9  " },
    {{ 0,  4,  7, 10, 14, 17 }, "Dom11 " },
    {{ 0,  4,  7, 10, 14, 21 }, "Dom13 " },
    // dominant chords with tensions
    {{ 0,  4,  6, 10, -1, -1 }, "7b5   " },
    {{ 0,  4,  8, 10, -1, -1 }, "7#5   " },
    {{ 0,  4,  7, 10, 13, -1 }, "7b9   " },
    {{ 0,  4,  7, 10, 15, -1 }, "7#9   " },
    // diminished
    {{ 0,  3,  6, -1, -1, -1 }, "DimTri" },
    {{ 0,  3,  6,  9, -1, -1 }, "Dim   " },
    // half diminished aka m7b5
    {{ 0,  3,  6, 10, -1, -1 }, "m7b5  " },
  }
};

//###########################
//# RIO: CHORD 3 REPLACEMENT
//###########################

static const seq_chord_entry_t seq_chord3_table[] = {
  // 1   2   3   4   5   6     <----> (6 chars!)
  {{-17, -12,  -8,  99,  99,  99 }, "inv II" },
  {{-16, -11,  -7,  99,  99,  99 }, "inv II" },
  {{-15, -10,  -6,  99,  99,  99 }, "inv II" },
  {{-14,  -9,  -5,  99,  99,  99 }, "inv II" },
  {{-13,  -8,  -4,  99,  99,  99 }, "inv II" },
  {{-12,  -7,  -3,  99,  99,  99 }, "inv II" },
  {{-11,  -6,  -2,  99,  99,  99 }, "inv II" },
  {{-10,  -5,  -1,  99,  99,  99 }, "inv II" },
  {{ -9,  -4,   0,  99,  99,  99 }, "inv II" },
  {{ -8,  -3,   1,  99,  99,  99 }, "inv II" },
  {{ -7,  -2,   2,  99,  99,  99 }, "inv II" },
  {{ -6,  -1,   3,  99,  99,  99 }, "inv II" },
  {{-12,  -8,  -5,  99,  99,  99 }, "root  " },
  {{-11,  -7,  -4,  99,  99,  99 }, "root  " },
  {{-10,  -6,  -3,  99,  99,  99 }, "root  " },
  {{ -9,  -5,  -2,  99,  99,  99 }, "root  " },
  {{ -8,  -4,  -1,  99,  99,  99 }, "root  " },
  {{ -7,  -3,   0,  99,  99,  99 }, "root  " },
  {{ -6,  -2,   1,  99,  99,  99 }, "root  " },
  {{ -5,  -1,   2,  99,  99,  99 }, "root  " },
  {{ -4,   0,   3,  99,  99,  99 }, "root  " },
  {{ -3,   1,   4,  99,  99,  99 }, "root  " },
  {{ -2,   2,   5,  99,  99,  99 }, "root  " },
  {{ -1,   3,   6,  99,  99,  99 }, "root  " },
  {{ -8,  -5,   0,  99,  99,  99 }, "inv I " },
  {{ -7,  -4,   1,  99,  99,  99 }, "inv I " },
  {{ -6,  -3,   2,  99,  99,  99 }, "inv I " },
  {{ -5,  -2,   3,  99,  99,  99 }, "inv I " },
  {{ -4,  -1,   4,  99,  99,  99 }, "inv I " },
  {{ -3,   0,   5,  99,  99,  99 }, "inv I " },
  {{ -2,   1,   6,  99,  99,  99 }, "inv I " },
  {{ -1,   2,   7,  99,  99,  99 }, "inv I " },
  {{  0,   3,   8,  99,  99,  99 }, "inv I " },
  {{  1,   4,   9,  99,  99,  99 }, "inv I " },
  {{  2,   5,  10,  99,  99,  99 }, "inv I " },
  {{  3,   6,  11,  99,  99,  99 }, "inv I " },
  {{ -5,   0,   4,  99,  99,  99 }, "inv II" },
  {{ -4,   1,   5,  99,  99,  99 }, "inv II" },
  {{ -3,   2,   6,  99,  99,  99 }, "inv II" },
  {{ -2,   3,   7,  99,  99,  99 }, "inv II" },
  {{ -1,   4,   8,  99,  99,  99 }, "inv II" },
  {{  0,   5,   9,  99,  99,  99 }, "inv II" },
  {{  1,   6,  10,  99,  99,  99 }, "inv II" },
  {{  2,   7,  11,  99,  99,  99 }, "inv II" },
  {{  3,   8,  12,  99,  99,  99 }, "inv II" },
  {{  4,   9,  13,  99,  99,  99 }, "inv II" },
  {{  5,  10,  14,  99,  99,  99 }, "inv II" },
  {{  6,  11,  15,  99,  99,  99 }, "inv II" },
  {{  0,   4,   7,  99,  99,  99 }, "root  " }, // C  E  G   root C
  {{  1,   5,   8,  99,  99,  99 }, "root  " }, // C# F  G#  root C#
  {{  2,   6,   9,  99,  99,  99 }, "root  " }, // D  F# A   root D
  {{  3,   7,  10,  99,  99,  99 }, "root  " }, // D# G  A#  root D#
  {{  4,   8,  11,  99,  99,  99 }, "root  " }, // E  G# B   root E
  {{  5,   9,  12,  99,  99,  99 }, "root  " }, // F  A  C   root F
  {{  6,  10,  13,  99,  99,  99 }, "root  " }, // F# A# C#  root F#
  {{  7,  11,  14,  99,  99,  99 }, "root  " }, // G  B  D   root G
  {{  8,  12,  15,  99,  99,  99 }, "root  " }, // G# C  D#  root G#
  {{  9,  13,  16,  99,  99,  99 }, "root  " }, // A  C# E   root A
  {{ 10,  14,  17,  99,  99,  99 }, "root  " }, // A# D  F   root A#
  {{ 11,  15,  18,  99,  99,  99 }, "root  " }, // B  D# F#  root B
  {{  4,   7,  12,  99,  99,  99 }, "inv I " },
  {{  5,   8,  13,  99,  99,  99 }, "inv I " },
  {{  6,   9,  14,  99,  99,  99 }, "inv I " },
  {{  7,  10,  15,  99,  99,  99 }, "inv I " },
  {{  8,  11,  16,  99,  99,  99 }, "inv I " },
  {{  9,  12,  17,  99,  99,  99 }, "inv I " },
  {{ 10,  13,  18,  99,  99,  99 }, "inv I " },
  {{ 11,  14,  19,  99,  99,  99 }, "inv I " },
  {{ 12,  15,  20,  99,  99,  99 }, "inv I " },
  {{ 13,  16,  21,  99,  99,  99 }, "inv I " },
  {{ 14,  17,  22,  99,  99,  99 }, "inv I " },
  {{ 15,  18,  23,  99,  99,  99 }, "inv I " },
  {{  7,  12,  16,  99,  99,  99 }, "inv II" },
  {{  8,  13,  17,  99,  99,  99 }, "inv II" },
  {{  9,  14,  18,  99,  99,  99 }, "inv II" },
  {{ 10,  15,  19,  99,  99,  99 }, "inv II" },
  {{ 11,  16,  20,  99,  99,  99 }, "inv II" },
  {{ 12,  17,  21,  99,  99,  99 }, "inv II" },
  {{ 13,  18,  22,  99,  99,  99 }, "inv II" },
  {{ 14,  19,  23,  99,  99,  99 }, "inv II" },
  {{ 15,  20,  24,  99,  99,  99 }, "inv II" },
  {{ 16,  21,  25,  99,  99,  99 }, "inv II" },
  {{ 17,  22,  26,  99,  99,  99 }, "inv II" },
  {{ 18,  23,  27,  99,  99,  99 }, "inv II" },
  {{ 12,  16,  19,  99,  99,  99 }, "root  " },
  {{ 13,  17,  20,  99,  99,  99 }, "root  " },
  {{ 14,  18,  21,  99,  99,  99 }, "root  " },
  {{ 15,  19,  22,  99,  99,  99 }, "root  " },
  {{ 16,  20,  23,  99,  99,  99 }, "root  " },
  {{ 17,  21,  24,  99,  99,  99 }, "root  " },
  {{ 18,  22,  25,  99,  99,  99 }, "root  " },
  {{ 19,  23,  26,  99,  99,  99 }, "root  " },
  {{ 20,  24,  27,  99,  99,  99 }, "root  " },
  {{ 21,  25,  28,  99,  99,  99 }, "root  " },
  {{ 22,  26,  29,  99,  99,  99 }, "root  " },
  {{ 23,  27,  30,  99,  99,  99 }, "root  " },
  {{ 16,  19,  24,  99,  99,  99 }, "inv I " },
  {{ 17,  20,  25,  99,  99,  99 }, "inv I " },
  {{ 18,  21,  26,  99,  99,  99 }, "inv I " },
  {{ 19,  22,  27,  99,  99,  99 }, "inv I " },
  {{ 20,  23,  28,  99,  99,  99 }, "inv I " },
  {{ 21,  24,  29,  99,  99,  99 }, "inv I " },
  {{ 22,  25,  30,  99,  99,  99 }, "inv I " },
  {{ 23,  26,  31,  99,  99,  99 }, "inv I " },
  {{ 24,  27,  32,  99,  99,  99 }, "inv I " },
  {{ 25,  28,  33,  99,  99,  99 }, "inv I " },
  {{ 26,  29,  34,  99,  99,  99 }, "inv I " },
  {{ 27,  30,  35,  99,  99,  99 }, "inv I " },
  {{ 19,  24,  28,  99,  99,  99 }, "inv II" },
  {{ 20,  25,  29,  99,  99,  99 }, "inv II" },
  {{ 21,  26,  30,  99,  99,  99 }, "inv II" },
  {{ 22,  27,  31,  99,  99,  99 }, "inv II" },
  {{ 23,  28,  32,  99,  99,  99 }, "inv II" },
  {{ 24,  29,  33,  99,  99,  99 }, "inv II" },
  {{ 25,  30,  34,  99,  99,  99 }, "inv II" },
  {{ 26,  31,  35,  99,  99,  99 }, "inv II" },
  {{ 27,  32,  36,  99,  99,  99 }, "inv II" },
  {{ 28,  33,  37,  99,  99,  99 }, "inv II" },
  {{ 29,  34,  38,  99,  99,  99 }, "inv II" },
  {{ 30,  35,  39,  99,  99,  99 }, "inv II" },
  {{ 24,  28,  31,  99,  99,  99 }, "root  " },
  {{ 25,  29,  32,  99,  99,  99 }, "root  " },
  {{ 26,  30,  33,  99,  99,  99 }, "root  " },
  {{ 27,  31,  34,  99,  99,  99 }, "root  " },
  {{ 28,  32,  35,  99,  99,  99 }, "root  " },
  {{ 29,  33,  36,  99,  99,  99 }, "root  " },
  {{ 30,  34,  37,  99,  99,  99 }, "root  " },
  {{ 31,  35,  38,  99,  99,  99 }, "root  " }, // C127
};

//###########################
//# RIO: END MODIFICATION
//###########################

/////////////////////////////////////////////////////////////////////////////
// Initialisation
/////////////////////////////////////////////////////////////////////////////
s32 SEQ_CHORD_Init(u32 mode)
{
  // here we could also generate the chord table in RAM...

  return 0; // no error
}


/////////////////////////////////////////////////////////////////////////////
// returns number of available chords
/////////////////////////////////////////////////////////////////////////////
s32 SEQ_CHORD_NumGet(u8 chord_set)
{
  if( chord_set == 2 ) {
    return sizeof(seq_chord3_table)/sizeof(seq_chord_entry_t);
  } else {
    return sizeof(seq_chord_table[0])/sizeof(seq_chord_entry_t);
  }
}


/////////////////////////////////////////////////////////////////////////////
// returns pointer to the name of a chord
// Length: 6 characters + zero terminator
/////////////////////////////////////////////////////////////////////////////
char *SEQ_CHORD_NameGet(u8 chord_set, u8 chord_ix)
{
  if( chord_ix == 0 || chord_ix >= SEQ_CHORD_NumGet(chord_set) )
    return "------";

  if( chord_set == 2 ) {
    return (char *)seq_chord3_table[chord_ix].name;
  } else {
    return (char *)seq_chord_table[chord_set][chord_ix].name;
  }
}


/////////////////////////////////////////////////////////////////////////////
// This function returns the transpose value of a chord with the given
// key number (0-3)
// IN: key number (0-3)
//     chord number (bit 4:0) and octave transpose value (7:5)
// returns note number if >= 0
// returns < 0 if no note defined for the given key
/////////////////////////////////////////////////////////////////////////////
s32 SEQ_CHORD_NoteGet(u8 key_num, u8 chord_set, u8 chord)
{
  if( key_num >= 6 )
    return -2; // key number too high

  if( chord_set >= 3 )
    return -3; // invalid chord set

  s32 note = 0;
  s32 oct_transpose = 0;

  //###########################
  //# RIO: CHORD 3 REPLACEMENT
  //###########################
  if( chord_set == 2 ) {
    note = (s32)seq_chord3_table[chord].keys[key_num];    

    if( note == 99 ) return -1;

  } else {
    u8 chord_ix = chord & 0x1f;
    oct_transpose = (chord >> 5) - 2;

    note = (s32)seq_chord_table[chord_set][chord_ix].keys[key_num];

    if( note < 0 ) return -1;
  }
  //###########################
  //# RIO: END MODIFICATION
  //###########################

  // add C-2
  note += 0x30;

  // transpose octave
  note += oct_transpose * 12;

  // ensure that note is in the 0..127 range
  note = SEQ_CORE_TrimNote(note, 0, 127);

  return note;
}
